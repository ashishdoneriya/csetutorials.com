<!doctype html><html lang=hi><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAQAAABLCVATAAAAdUlEQVR4Ae3MIRJAUBCH8e81R3AO53AmvIQmu5MzqE8iKoZAEdZYZhT7/cuGnR9/yeEJrDcW8DjEKlbFasQmFTQitj+cK2TqO8ggg2LceygiZ6YjeQel9Me10NI8ghR7DhlkkEFBxQTEShVUcVHGcAsZ8PylDecfc51kCzSlAAAAAElFTkSuQmCC type=image/x-icon><link rel=preload href=https://csetutorials.com/fonts/Roboto.ttf as=font type=font/ttf crossorigin=anonymous><link rel=preload href=https://csetutorials.com/fonts/RobotoMono.ttf as=font type=font/ttf crossorigin=anonymous><link rel=preload href=https://csetutorials.com/fonts/Roboto-Italic.ttf as=font type=font/ttf crossorigin=anonymous><link rel=preload href=https://csetutorials.com/fonts/RobotoMono-Italic.ttf as=font type=font/ttf crossorigin=anonymous><link rel=stylesheet href=https://csetutorials.com/scss/main.min.css><title>How to run threadsafe code in PHP</title>
<meta name=description content="Tutorial to acquire lock in PHP and run a thread safe code so that only one thread could execute a portion of code at a time."><meta name=author content="Ashish Doneriya"><meta name=robots content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"><link rel=canonical href=https://csetutorials.com/threadsafe-code-in-php.html><meta property="og:type" content="article"><meta property="og:title" content="How to run threadsafe code in PHP"><meta property="og:description" content="Tutorial to acquire lock in PHP and run a thread safe code so that only one thread could execute a portion of code at a time."><meta name=keywords content="php"><meta property="og:url" content="https://csetutorials.com/threadsafe-code-in-php.html"><meta property="og:site_name" content="Cse Tutorials"><meta property="article:published_time" content="2019-05-10T09:09:18+05:30"><meta property="article:modified_time" content="2019-05-10T09:09:18+05:30"><meta property="article:author" content="Ashish Doneriya"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="How to run threadsafe code in PHP"><meta name=twitter:description content="Tutorial to acquire lock in PHP and run a thread safe code so that only one thread could execute a portion of code at a time."><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"How to run threadsafe code in PHP","description":"Tutorial to acquire lock in PHP and run a thread safe code so that only one thread could execute a portion of code at a time.","author":{"@type":"Person","name":"Ashish Doneriya"},"keywords":["\"%!s(MISSING)\""],"articleSection":["\"%!s(MISSING)\""],"datePublished":"2019-05-10T09:09:18\u002b05:30","dateModified":"2019-05-10T09:09:18\u002b05:30","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/csetutorials.com\/threadsafe-code-in-php.html"},"url":"https:\/\/csetutorials.com\/threadsafe-code-in-php.html"}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-VQ66771MZZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VQ66771MZZ")</script></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><div class=container><a class=navbar-brand href=/>Cse Tutorials</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse justify-content-end" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/about-us/>About us</a></li><li class=nav-item><a class=nav-link href=/contact-us/>Contact us</a></li><li class=nav-item><a class=nav-link href=/privacy-policy/>Privacy Policy</a></li><li class=nav-item><a class=nav-link href=/terms-of-service/>Terms of Service</a></li><li class=nav-item><a class=nav-link href=/topics/>Topics</a></li></ul></div></div></nav><main><article class=page-wrapper><h1 class="mb-4 text-center">How to run threadsafe code in PHP</h1><div class="d-flex justify-content-center align-items-center mb-4 text-muted small"><time datetime="2019-05-10 09:09:18 +0530 +0530">May 10, 2019</time>
<span class=mx-2>|</span>
<span>Ashish Doneriya</span>
<span class=mx-2>|</span>
<a class=text-decoration-none href=/topics/web-development rel=category>Web Development</a></div><div class=post-content><p>Suppose you have a php file in which there is a code block which you want thread safe. It means, if that php file is being called from many places simultaneously and you want the code block to be executed one by one irrespective of being called at the same time by different places. So here is the theory :</p><ol><li>Create a temporary directory if not exits.</li><li>Check whether temporary directory is empty or not. If not empty then repeat this step ( step 2) after some time, lets say 50 milliseconds. If empty then go to step 3</li><li>Fetch current timestamp in milliseconds (milliseconds since 1 Jan 1970). Create a directory with that timestamp inside the temporary directory. In this way that temp directory will contain directories whose filename is a number.</li><li>Now check all the files inside that temporary directory and check whether our timestamp is the lowest number among all file name. If it is the lowest timestamp then you have acquired the lock and go to step 5, if not it means somebody already acquired the lock and therefore sleep for 50 milliseconds and then go to step 2.</li><li>Write down your thread safe code.</li><li>Now to release the lock, delete that temporary directory and all it sub directories recursively.</li><li>Thats it. Here is a sample program</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$lockPath <span style=color:#f92672>=</span>	<span style=color:#e6db74>&#39;tempDir/lock/&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>file_exists</span>($lockPath)) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mkdir</span>($lockPath, <span style=color:#ae81ff>0777</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>	 $lock <span style=color:#f92672>=</span> <span style=color:#a6e22e>getLock</span>($lockPath);
</span></span><span style=display:flex><span>	 <span style=color:#66d9ef>if</span> ($lock <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	 }
</span></span><span style=display:flex><span>	 <span style=color:#a6e22e>sleep</span>(<span style=color:#a6e22e>mt_rand</span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>50</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Your thread safe code goes here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// releasing the lock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>file_exists</span>($lockPath)) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	 $handle <span style=color:#f92672>=</span> <span style=color:#a6e22e>opendir</span>($lockPath);
</span></span><span style=display:flex><span>	 <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>false</span> <span style=color:#f92672>!==</span> ($entry <span style=color:#f92672>=</span> <span style=color:#a6e22e>readdir</span>($handle))) {
</span></span><span style=display:flex><span>	 <span style=color:#66d9ef>if</span> ($entry <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>&amp;&amp;</span> $entry <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;..&#39;</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>rrmdir</span>($lockPath <span style=color:#f92672>.</span> $entry);
</span></span><span style=display:flex><span>	 }
</span></span><span style=display:flex><span>	 }
</span></span><span style=display:flex><span>	 <span style=color:#a6e22e>closedir</span>($handle);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>rrmdir</span>($dir) {
</span></span><span style=display:flex><span>	 <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is_dir</span>($dir)) {
</span></span><span style=display:flex><span>		$objects <span style=color:#f92672>=</span> <span style=color:#a6e22e>scandir</span>($dir);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>foreach</span> ($objects <span style=color:#66d9ef>as</span> $object) {
</span></span><span style=display:flex><span>		 <span style=color:#66d9ef>if</span> ($object <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>&amp;&amp;</span> $object <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;..&#34;</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is_dir</span>($dir<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>.</span>$object))
</span></span><span style=display:flex><span>				 <span style=color:#a6e22e>rrmdir</span>($dir<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>.</span>$object);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>				 <span style=color:#a6e22e>unlink</span>($dir<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>.</span>$object);
</span></span><span style=display:flex><span>		 }
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>rmdir</span>($dir);
</span></span><span style=display:flex><span>	 }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getLock</span>($lockPath) {
</span></span><span style=display:flex><span>	 <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is_dir_empty</span>($lockPath) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>		$milliseconds <span style=color:#f92672>=</span> <span style=color:#a6e22e>round</span>(<span style=color:#a6e22e>microtime</span>(<span style=color:#66d9ef>true</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mkdir</span>($lockPath<span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>.</span>$milliseconds, <span style=color:#ae81ff>0777</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>isLowestTimestamp</span>($lockPath, $milliseconds);
</span></span><span style=display:flex><span>	 } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	 }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>isLowestTimestamp</span>($path, $milliseconds) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	 $dir <span style=color:#f92672>=</span> <span style=color:#a6e22e>opendir</span>($path);
</span></span><span style=display:flex><span>	 <span style=color:#66d9ef>while</span>(<span style=color:#66d9ef>false</span> <span style=color:#f92672>!=</span> ($file <span style=color:#f92672>=</span> <span style=color:#a6e22e>readdir</span>($dir))) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>(($file <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;.&#34;</span>) <span style=color:#f92672>&amp;&amp;</span> ($file <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;..&#34;</span>)) {
</span></span><span style=display:flex><span>				 <span style=color:#66d9ef>if</span> ((<span style=color:#a6e22e>int</span>)$file <span style=color:#f92672>&lt;</span> $milliseconds) {
</span></span><span style=display:flex><span>				 <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	 }
</span></span><span style=display:flex><span>	 <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>is_dir_empty</span>($dir) {
</span></span><span style=display:flex><span>	 $handle <span style=color:#f92672>=</span> <span style=color:#a6e22e>opendir</span>($dir);
</span></span><span style=display:flex><span>	 <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>false</span> <span style=color:#f92672>!==</span> ($entry <span style=color:#f92672>=</span> <span style=color:#a6e22e>readdir</span>($handle))) {
</span></span><span style=display:flex><span>	 <span style=color:#66d9ef>if</span> ($entry <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>&amp;&amp;</span> $entry <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;..&#39;</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>closedir</span>($handle);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	 }
</span></span><span style=display:flex><span>	 }
</span></span><span style=display:flex><span>	 <span style=color:#a6e22e>closedir</span>($handle);
</span></span><span style=display:flex><span>	 <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div></div></article></main><script async src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js defer></script></body></html>